<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>MusicMonster.co</title>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

            <script type="text/javascript">


        </script>

</head>
<body>


<h1>Now playing : <strong></strong></h1>

<style type="text/css">
    em {
        margin-left: 20px
    }
    .hide{display:none}
</style>

<script type="text/javascript" src="https://raw.github.com/janl/mustache.js/master/mustache.js"></script>
<script type="text/javascript">


    BY = (function() {

        var by = []
        by.app = {

            init: function() {
                by.app.handleListeners.buttonInterface()
                songIds = [],
                songHot = [],
                songFam = [],
                crowdHot = [],
                crowdFam = []

                by.app.visChart()

            },
            updateChartVotes:function(){
              var urlFeedback='/feedback/' + $('body').attr('data-venueid')
                                  
              $.ajax({
                  url:urlFeedback,
                  type:'GET',
                  success:function(dat){
                    var songs=[]
                    $(dat.songs).each(function() {
                      songs[this.id]=this.echo_nest_song_id
                    })
                    
                    chart_dirty=false
                    
                    sHot=songHot.pop()
                    songHot.push(sHot)
                    sFam=songFam.pop()
                    songFam.push(sFam)
                    
                    cHotNew=sHot
                    cFamNew=sFam
                    
                    $(songIds).each(function(){
                      sid=this
                      $(dat.feedback).each(function(){
                        feedback_song_id=songs[this.song_id]                                                
                         if ( feedback_song_id == sid ){
                           if (this.vote_attribute === 'more hot'){
                             cHotNew=cHotNew+0.25
                           } else if (this.vote_attribute === 'less hot') {
                             cHotNew=cHotNew-0.25
                           } else if (this.vote_attribute === 'more familiar') {
                             cFamNew=cFamNew+0.25
                           } else if (this.vote_attribute === 'less familiar') {
                             cFamNew=cFamNew-0.25
                           }                           
                         }
                      })
                        
                    })
                    
                    // detect if anything changed
                    cHotOrig=crowdHot.pop()
                    if (cHotOrig === cHotNew){                      
                      crowdHot.push(cHotOrig)
                    } else{
                      crowdHot.push(cHotNew)
                      chart_dirty=true
                    }
                    
                    cFamOrig=crowdFam.pop()
                    if (cFamOrig === cFamNew){                      
                      crowdFam.push(cFamOrig)
                    } else{
                      crowdFam.push(cFamNew)
                      chart_dirty=true
                    }
                    
                    if (chart_dirty){                      
                      by.app.visChart()
                    }                               
                  }
              })
            },
            
            visChart:function(){
                var chart;
                $(document).ready(function() {
                    // var baseArray = [5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0]

                    chart = new Highcharts.Chart({
                        chart: {
                            renderTo: 'container',
                            defaultSeriesType: 'line',
                            marginRight: 130,
                            marginBottom: 25
                        },
                        title: {
                            text: 'Song Familiarity and Hotttness',
                            x: -20 //center
                        },
                        subtitle: {
                            text: 'Source: EchoNest.com',
                            x: -20
                        },
                        xAxis: {
                            // categories: ['Rock', 'Pop', 'HipHop', 'Punk', 'Ska', 'Metal',
                            //      'Breaks', 'Trance', 'House', 'Oldies', 'Symphony', 'Jazz']
                            categories: ['','','','','','','','','','','','']
                        },
                        yAxis: {
                            title: {
                                text: 'Song Hotttness'
                            },
                            plotLines: [{
                                value: 0,
                                width: 1,
                                color: '#808080'
                            }]
                        },
                        tooltip: {
                            formatter: function() {
                                    return '<b>'+ this.series.name +'</b><br/>'+
                                    this.x +': '+ this.y +'Â°C';
                            }
                        },
                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'top',
                            x: -10,
                            y: 100,
                            borderWidth: 0
                        },
                        series: [{
                            name: 'Song Hotness',
                            data: songHot
                        }, {
                            name: 'Song Familiarity',
                            data: songFam
                        }, {
                            name: 'Crowd Hotness',
                            data: crowdHot
                        },{
                            name: 'Crowd Familiarity',
                            data: crowdFam
                        }
                        ]
                    });
                });                
            },
            populateUserUI: function(){
                var userInterfaceTemplate = 'foo'
                $('body').append('<div id=user-ui />')
                $('#user-ui').append(userInterfaceTemplate)

                var view = {    
                  familiarity:'val',
                  hotttness:'val2'
                  }

                var output = Mustache.render("<label>song familiarity</label> <input value={{familiarity}}> <label>hotness</label><input value={{hotttness}}>", view);
                $('body').append(output)

                                                
            },
            accomodateUser:{
                selectUser:function(){
                    console.log()
                    if(window.location.hash.indexOf('type=dj') === -1){
                        by.app.accomodateUser.listenUser.listenerInit()
                    } else {
                        by.app.accomodateUser.djUser.djInit()
                    }
                },
                djUser:{
                    djInit:function(){
                        console.log('hide')
                        var modifyFam = .5,                        
                        modifyDesc = 'disco',
                        modifyResults = 20,
                        modifyStyle = '90s',
                        modifyHot = .5
                        by.app.showSongs(modifyStyle,modifyDesc,modifyFam,modifyResults,modifyHot)

                    }
                },
                listenUser:{
                    listenerInit:function(){
                        console.log('start listening') 
                        $('#song-vote').show()
                        //by.app.fetchCurrentSong() 
                        setInterval('BY.app.fetchCurrentSong()', 5000)
                        setTimeout('setInterval("BY.app.updateChartVotes()", 3000)', 8000) 
                    }
                }
            },
            handleListeners:{
                feedback:function(voteAttr){
                    var url = '/feedback',
                        $echoNestSong = $('body').attr('data-echonestid'),
                        $fourSquareVenue = $('body').attr('data-venueid'),
                        $fourSquareListener = $('body').attr('data-foursqid')

                    $.ajax({
                      url:url,
                      data: {feedback:{echo_nest_song_id: $echoNestSong, foursquare_venue_id: $fourSquareVenue, listener_foursquare_id: $fourSquareListener, vote_attribute: voteAttr}},
                      type:'POST'
                    });     
                },
                buttonInterface:function(){
                    console.log('btn int')
                    $('#song-vote a').live('click',function(e){
                      e.preventDefault()
                      var voteAttr = $(this).text()
                      by.app.handleListeners.feedback(voteAttr)
                    })
                }
            },            
            fetchCurrentSong:function() {

                // $venueId = '4e6616838877954de9b79ab8'
                // $returnedSongId = 'SOOSHQA1315CD49B9B'
                var defUrl = '/songs/' + $('body').attr('data-venueid')
                $.ajax({
                    url:defUrl,
                    type:'GET',
                    success:function(data) {

                        $returnedSongId = data.song.echo_nest_song_id

                        if (!$('body').attr('data-echonestid') || !($('body').attr('data-echonestid') == $returnedSongId) ){ 
                          
                          var newUrl = 'http://developer.echonest.com/api/v4/song/profile?api_key=N6E4NIOVYMTHNDM8J&format=json&id=' + $returnedSongId
                          $.ajax({
                              url:newUrl,
                              type:'GET',
                              success:function(data) {
                                  var songTitle = data.response.songs[0].title,
                                          artistName = data.response.songs[0].artist_name
  
                                  $('h1>strong').text(songTitle + ', ' + artistName)
                                  $('body').attr('data-echonestid',$returnedSongId)
  
                                  var artistId = data.response.songs[0].artist_id
                                  var songId = data.response.songs[0].id
                                  
                                  songIds.push(songId)
  
                                  var url = 'http://developer.echonest.com/api/v4/artist/hotttnesss?api_key=N6E4NIOVYMTHNDM8J&id=' + artistId + '&format=json',
                                      urlFam = 'http://developer.echonest.com/api/v4/artist/familiarity?api_key=N6E4NIOVYMTHNDM8J&id=' + artistId + '&format=json'
                                  $.ajax({
                                      url:url,
                                      type:'GET',
                                      success:function(data){
                                          var thisHotness = data.response.artist.hotttnesss * 10
                                          console.log(thisHotness)
                                          songHot.push(thisHotness)
                                          crowdHot.push(thisHotness)
                                          by.app.visChart()                                                    
                                      }
                                  })
                                  $.ajax({
                                      url:urlFam,
                                      type:'GET',
                                      success:function(dat){
                                          songFam.push(dat.response.artist.familiarity * 10)
                                          crowdFam.push(dat.response.artist.familiarity * 10)
                                          by.app.visChart() 
                                      }
                                  })
                                                                    
                                  
                                  
                              }
                          })
                      }
                    }
                })
            },
            fetchToken:function() {
                $token = window.location.hash.split('=')[1]

                var venueSearch = 'https://api.foursquare.com/v2/venues/search?ll=40.740648,-73.98689&oauth_token=' + $token


                $.ajax({url:venueSearch,type:'GET',success:function(data) {

                    $(data.response.groups[0].items).each(function() {
                        $venueId = this.id

                        $('body').append('<div id=loc />')
                        $('#loc').append('<li><a class=' + this.id + ' href=/ >' + this.name + '</a></li>')


                    })
                }})


                $('#loc a').live('click', function(e) {
                    e.preventDefault()
                    $venueId = $(this).attr('class')
                    var url = 'https://api.foursquare.com/v2/checkins/add?venueId=' + $venueId + '&oauth_token=' + $token
                    $.ajax({
                        url:url,
                        type:'POST',
                        success:function(dat) {
                            $('body').attr('data-venueid', $venueId)
                            $('#loc li').hide()

                            by.app.accomodateUser.selectUser()

                        }
                    })
                })
            },
            showSongs:function(modifyStyle,modifyDesc,modifyFam,modifyResults,modifyHot) {
                var modifyMinFam = modifyFam - .1,
                    modifyMaxFam = modifyFam + .1,
                    modifyDesc = 'disco',
                    modifyResults = 20,
                    modifyStyle = '90s',
                    modifyMinHot = modifyHot - .1,
                    modifyMaxHot = modifyHot + .1

                var url = 'http://developer.echonest.com/api/v4/playlist/static?api_key=N6E4NIOVYMTHNDM8J&description=' + modifyStyle + '&description=' + modifyDesc + '&type=artist-description&artist_min_familiarity=' + modifyMinFam + '&artist_max_familiarity=' + modifyMaxFam + '&sort=tempo-asc&results=' + modifyResults + '&artist_min_hotttnesss=' + modifyMinHot + '&artist_max_hotttnesss=' + modifyMaxHot + '&variety=.5'
                $.ajax({
                    url:url,
                    type:'GET',
                    success:function(dat) {
                        $(dat.response.songs).each(function() {
                            $('body').append('<ul id=dj-songs />')
                            $('#dj-songs').append('<li><a data-songid=' + this.id + ' href=/ >' + this.title + '</a><em>' + this.artist_name + '</em></li>')
                        })
                    }
                })

                var getUserObjUrl = 'https://api.foursquare.com/v2/users/self?oauth_token=' + $token + '&v=20120225'
                $.ajax({
                    url:getUserObjUrl,
                    type:'GET',
                    success:function(data) {
                        $userFoursquareId = data.response.user.id
                        $('body').attr('data-foursqid',$userFoursquareId)
                    }
                })

                $('#dj-songs a').live('click', function(e) {
                    e.preventDefault()
                    // songs/location/:songid/:authid
                    // songs/location/songid=123
                    var url = '/songs',
                            $echoNestSongId = $(this).attr('data-songid')
                    $.ajax({
                        url:url,
                        data: {song:{foursquare_venue_id: $venueId,dj_foursquare_id:$userFoursquareId,echo_nest_song_id:$echoNestSongId}},
                        type:'POST',
                        success:function() {
                            by.app.fetchCurrentSong()
                        }
                    })

                })
            }
        }
        by.app.fetchToken()
        by.app.init()
        return by


    }())


</script>







<script type="text/javascript" src="/javascripts/highcharts.js"></script>
<script type="text/javascript" src="/javascripts/exporting.js"></script>

<div id="container" style="width: 800px; height: 400px; margin: 0 auto"></div>
<ul id=song-vote class=hide>
    <li><a class=vote-less-hot href="/">less hot</a></li>
    <li><a class=vote-hot href="/">more hot</a></li>
    <li><a class=vote-same href="/">same</a></li>
    <li><a class=vote-familiar href="/">more familiar</a></li>
    <li><a class=vote-less-familiar href="/">less familiar</a></li>
</ul>

</body>
</html>